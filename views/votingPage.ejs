<!DOCTYPE html>
<html>

<head>
  <title><%= title %></title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
</head>

<body>
  <h1><%= title %></h1>
  <%= votingData.title %><br>
  <%= votingData.writer %><br>
  <%= votingData.description %><br>
  <%= votingData.expiration_date %><br>
  <%= votingData.progress %><br>
  <select>
    <option value="선택">선택</option>
    <% for(let i=0; i < votingData.select_option.length; i++) { %>
    <option class="option" value="<%= votingData.select_option[i] %>"><%= votingData.select_option[i] %></option>
    <% } %>
  </select>
  <a class="vote" href="/votings/<%= votingData.id %>">투표하기</a>
  <% if(deleteBtn) { %>
  <a class="deleteBtn" href="/votings/<%= votingData.id %>"><%= deleteBtn %></a>
  <% } %>
  <a href="/">투표 목록으로 돌아가기</a>

  <script>
    const deleteBtn = document.querySelector('.deleteBtn');
    const vote = document.querySelector('.vote');
    const voteUrl = vote.href;
    const option = document.querySelector('.option');
   

    vote.addEventListener('click', () => {
      fetch(voteUrl, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ value: option.value })
      })
      .then((res) => {
        return res.json();
      })
      .then((myJson) => {
        if(!myJson.result) {
          alert('로그인 하셔야 투표하실 수 있습니다.');
          window.location.href = '/login';
        } else if( myJson.result === 'overlap') {
          alert('중복 투표는 불가능합니다.');
        } else {
          alert('투표 성공');
        }
      })
      .catch((err) => {
        console.log(err);
      });
    });

    if (deleteBtn) {
      const url = deleteBtn.href;
      deleteBtn.addEventListener('click', () => {
        fetch(url, {
          method: 'DELETE',
        });
      });
    }

  </script>
</body>

</html>
